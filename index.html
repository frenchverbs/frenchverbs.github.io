<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Franz√∂sisch Verben Quiz</title>
  <style>
    body { font-family: sans-serif; background: #f0f4f8; padding: 2rem; text-align: center; }
    h1 { margin-bottom: 1rem; color: #333; }
    #setup, #quiz, #result, #overview, #filter { display: none; margin-top: 2rem; }
    select, button, input[type="number"], input[type="text"] {
      font-size: 1rem;
      margin: 0.5rem;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button { cursor: pointer; background-color: #007bff; color: white; border: none; }
    button:hover { background-color: #0056b3; }
    #question-box { font-size: 1.2rem; margin-top: 1rem; }
    #feedback { margin-top: 1rem; font-weight: bold; min-height: 1.5rem; }
    #total-time { margin-top: 1rem; font-size: 0.9rem; color: #666; }
    #verb-list { text-align: left; max-width: 600px; margin: 1rem auto; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #verb-list ul { list-style: none; padding: 0; }
    #verb-list li { padding: 0.3rem 0; border-bottom: 1px solid #eee; }
    #verb-list li span { float: right; font-weight: bold; }
    #prefix { font-weight: bold; margin-right: 0.5rem; }
  </style>
</head>
<body>
  <h1>Franz√∂sisch Verben Quiz</h1>
  <div id="setup">
    <label>Wie viele Minuten m√∂chtest du √ºben?</label><br>
    <input id="minutes" type="number" value="10" min="1" max="120"> Minuten<br>
    <button onclick="startSession()">Starten</button>
    <button onclick="showOverview()" style="background-color: #6c757d;">Lern√ºbersicht</button>
    <button onclick="showFilter()" style="background-color: #17a2b8;">Filter</button>
    <div id="total-time"></div>
    <a href="https://cestca.vocatrainer.memorylab.app/#/lessons?tab=library">VocabTrainer</a>
  </div>

  <div id="filter">
    <h2>Filtereinstellungen</h2>
    <label>Verben ausschlie√üen (Komma-getrennt):</label><br>
    <input id="excluded-verbs" type="text" placeholder="z.‚ÄØB. √™tre, avoir"><br>

    <label>Zeiten ausschlie√üen:</label><br>
    <label><input type="checkbox" class="excluded-tense" value="present"> Pr√©sent</label>
    <label><input type="checkbox" class="excluded-tense" value="imparfait"> Imparfait</label>
    <label><input type="checkbox" class="excluded-tense" value="passe"> Pass√© compos√©</label><br>

    <label>Personen ausschlie√üen:</label><br>
    <label><input type="checkbox" class="excluded-person" value="0"> je</label>
    <label><input type="checkbox" class="excluded-person" value="1"> tu</label>
    <label><input type="checkbox" class="excluded-person" value="2"> il/elle</label>
    <label><input type="checkbox" class="excluded-person" value="3"> nous</label>
    <label><input type="checkbox" class="excluded-person" value="4"> vous</label>
    <label><input type="checkbox" class="excluded-person" value="5"> ils/elles</label><br><br>

    <button onclick="hideFilter()">Zur√ºck</button>
  </div>

  <div id="quiz">
    <div id="timer"></div>
    <div id="question-box"></div>
    <div><span id="prefix"></span><input type="text" id="answer" placeholder="Antwort..." autocomplete="off"></div>
    <div>
      <button id="submit-btn" onclick="submitAnswer()">Antwort √ºberpr√ºfen</button>
      <button id="next-btn" onclick="nextQuestion()" style="display:none">N√§chste Frage</button>
      <button onclick="abortSession()" style="background-color:#dc3545;">Abbrechen</button>
    </div>
    <div id="feedback"></div>
  </div>

  <div id="result">
    <p>Fertig! üéâ</p>
    <button onclick="restart()">Nochmal √ºben</button>
  </div>

  <div id="overview">
    <div id="verb-list"></div>
    <button onclick="restart()">Zur√ºck</button>
  </div>

  <script type="module">
    import { verbs } from './verbs.js';

    const persons = ["je", "tu", "il/elle", "nous", "vous", "ils/elles"];
    let excludedVerbs = [], excludedTenses = [], excludedPersons = [];
    let sessionEnd, sessionStart, sessionLength;
    let currentVerb, currentTense, currentPerson, correctAnswer;
    let learnedStats = JSON.parse(localStorage.getItem("learnedStats") || "{}");
    let totalMinutes = parseInt(localStorage.getItem("totalMinutes") || "0");
    let interval = null;

    const setup = document.getElementById("setup");
    const quiz = document.getElementById("quiz");
    const result = document.getElementById("result");
    const overview = document.getElementById("overview");
    const filter = document.getElementById("filter");
    const questionBox = document.getElementById("question-box");
    const feedback = document.getElementById("feedback");
    const timer = document.getElementById("timer");
    const answerInput = document.getElementById("answer");
    const prefix = document.getElementById("prefix");
    const totalDisplay = document.getElementById("total-time");
    const verbList = document.getElementById("verb-list");
    const submitBtn = document.getElementById("submit-btn");
    const nextBtn = document.getElementById("next-btn");

    totalDisplay.textContent = `Bisher insgesamt ge√ºbt: ${totalMinutes} Minute(n)`;
    setup.style.display = "block";

    function showFilter() {
      setup.style.display = "none";
      filter.style.display = "block";
    }

    function hideFilter() {
      filter.style.display = "none";
      setup.style.display = "block";
    }

    function startSession() {
      const minutes = parseInt(document.getElementById("minutes").value);
      if (!minutes || minutes <= 0) return alert("Bitte eine g√ºltige Zeit angeben.");
      sessionLength = minutes;
      sessionStart = Date.now();
      sessionEnd = sessionStart + minutes * 60 * 1000;

      excludedVerbs = document.getElementById("excluded-verbs").value.split(",").map(v => v.trim()).filter(Boolean);
      excludedTenses = Array.from(document.querySelectorAll(".excluded-tense:checked")).map(cb => cb.value);
      excludedPersons = Array.from(document.querySelectorAll(".excluded-person:checked")).map(cb => parseInt(cb.value));

      setup.style.display = "none";
      quiz.style.display = "block";
      nextQuestion();
      updateTimer();
    }

    function updateTimer() {
      clearInterval(interval);
      interval = setInterval(() => {
        const timeLeft = sessionEnd - Date.now();
        if (timeLeft <= 0) {
          clearInterval(interval);
          finishSession();
        } else {
          const min = Math.floor(timeLeft / 60000);
          const sec = Math.floor((timeLeft % 60000) / 1000);
          timer.textContent = `Verbleibend: ${min}:${sec.toString().padStart(2, '0')}`;
        }
      }, 1000);
    }

    function weightedRandomVerb() {
      const keys = Object.keys(verbs);
      const pool = keys.flatMap(key => {
        const score = learnedStats[key]?.score || 0;
        const weight = Math.max(1, 5 - score);
        return Array(weight).fill(key);
      });
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function nextQuestion() {
      let tries = 0;
      const availableTenses = ["present", "imparfait", "passe"].filter(t => !excludedTenses.includes(t));
      const availablePersons = [0, 1, 2, 3, 4, 5].filter(p => !excludedPersons.includes(p));

      if (availableTenses.length === 0 || availablePersons.length === 0) {
        alert("Bitte w√§hle mindestens eine Zeitform und eine Person aus.");
        abortSession();
        return;
      }

      do {
        currentVerb = weightedRandomVerb();
        currentTense = availableTenses[Math.floor(Math.random() * availableTenses.length)];
        currentPerson = availablePersons[Math.floor(Math.random() * availablePersons.length)];
        tries++;
        if (tries > 100) {
          alert("Keine g√ºltige Kombination gefunden. Bitte √ºberpr√ºfe deine Filter.");
          abortSession();
          return;
        }
      } while (excludedVerbs.includes(currentVerb));

      const form = verbs[currentVerb][currentTense];
      correctAnswer = form[currentPerson];
      questionBox.textContent = `${currentVerb} ‚Äì ${currentTense} ‚Äì ${persons[currentPerson]}`;
      prefix.textContent = (correctAnswer.match(/^(j'|j‚Äô|je|tu|il|elle|nous|vous|ils|elles|je me|je m'|je m‚Äô)/i) || [''])[0] + ' ';
      feedback.textContent = "";
      answerInput.value = "";
      answerInput.focus();
      submitBtn.style.display = "inline-block";
      nextBtn.style.display = "none";
    }

    function submitAnswer() {
      const clean = s => s.toLowerCase().replace(/^(je|j'|j‚Äô|tu|il|elle|nous|vous|ils|elles|je me|je m'|je m‚Äô)\s+/, "").trim();
      const user = clean(answerInput.value);
      const correct = clean(correctAnswer);

      if (!learnedStats[currentVerb]) learnedStats[currentVerb] = { score: 0 };
      if (user === correct) {
        learnedStats[currentVerb].score = Math.min(5, learnedStats[currentVerb].score + 1);
        feedback.textContent = "‚úÖ Richtig!";
      } else {
        learnedStats[currentVerb].score = Math.max(0, learnedStats[currentVerb].score - 1);
        feedback.textContent = `‚ùå Falsch. Richtig w√§re: ${correctAnswer}`;
      }
      localStorage.setItem("learnedStats", JSON.stringify(learnedStats));
      submitBtn.style.display = "none";
      nextBtn.style.display = "inline-block";
    }

    function finishSession() {
      const actualMinutes = Math.round((Date.now() - sessionStart) / 60000);
      totalMinutes += actualMinutes;
      localStorage.setItem("totalMinutes", totalMinutes);
      quiz.style.display = "none";
      result.style.display = "block";
    }

    function abortSession() {
      clearInterval(interval);
      finishSession();
    }

    function showOverview() {
      setup.style.display = "none";
      overview.style.display = "block";
      const entries = Object.keys(verbs).sort().map(key => {
        const score = learnedStats[key]?.score || 0;
        let level = "‚ùå schlecht";
        if (score >= 5) level = "‚úÖ gemeistert";
        else if (score >= 3) level = "üü° ok";
        return `<li>${key}<span>${level}</span></li>`;
      }).join("");
      verbList.innerHTML = `<h3>Dein Lernstand:</h3><ul>${entries}</ul>`;
    }

    function restart() {
      result.style.display = "none";
      overview.style.display = "none";
      filter.style.display = "none";
      setup.style.display = "block";
      totalDisplay.textContent = `Bisher insgesamt ge√ºbt: ${totalMinutes} Minute(n)`;
    }

    window.startSession = startSession;
    window.abortSession = abortSession;
    window.restart = restart;
    window.showOverview = showOverview;
    window.showFilter = showFilter;
    window.hideFilter = hideFilter;
    nextBtn.addEventListener("click", nextQuestion);
document.getElementById("submit-btn").addEventListener("click", submitAnswer);
    answerInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && submitBtn.style.display !== "none") submitAnswer();
    });
  </script>
</body>
</html>
